---
title: "Numerai Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    social: menu
    source_code: https://github.com/Omni-Analytics-Group/numerdash
    theme: united
    css: css/styles.css
    logo: images/omni_numerai.png
    favicon: images/favicon.ico
runtime: shiny
---

```{r setup, include=FALSE}
library(Rnumerai)
library(shiny)
library(ggplot2)
library(ggridges)
library(plotly)
library(dplyr)
library(tidyr)
library(DT)
library(flexdashboard)
```

Quick Stats
=====================================

Inputs {.sidebar data-width=300}
-----------------------------------------------------------------------

```{r}
h4("About")

helpText("This dashboard allows users to visualize the results of prior Numerai tournaments over time. To begin, enter your Public ID and Secret Key generated by the Numerai API.")

hr()

h4("API Access Information")

textInput("pub_id", "Enter Public ID")
textInput("sec_key", "Enter Secret Key")
actionButton("api_data_go", label = "Go")

data_fetch <- reactiveValues(uinfo=NULL,round_res=NULL)
data_stat <- reactiveValues(mean=NULL,median=NULL,sd=NULL,min=NULL,max=NULL,cum_nmr_e=NULL,cum_nmr_d=NULL,cum_nmr_s=NULL,cum_usd_e=NULL,num_p=NULL)

observeEvent(input$api_data_go, {
    my_pub_id <- input$pub_id
    my_sec_key <- input$sec_key
    
    res1 <- try(set_public_id(my_pub_id), silent = TRUE)
    res2 <- try(set_api_key(my_sec_key), silent = TRUE)
    
    if (inherits(res1, "try-error") || inherits(res2, "try-error")) {
        my_pub_id <- readLines("data/pub_id.txt")
        my_sec_key <- readLines("data/sec_key.txt")
        
        set_public_id(my_pub_id)
        set_api_key(my_sec_key)
    }
    
                                    ## Check if cache available or generate fresh files 
                                    cache <- NULL
                                    if("cache.Rdata" %in% list.files("data"))
                                    {
                                        load("data/cache.Rdata")
                                        data_fetch$round_res <- cache
                                    }

                                    ## Fetch user information
                                    data_fetch$uinfo = user_info()

                                    ## Boolean to track scraping work
                                    cont = TRUE

                                    ## Round number from where to start
                                    round=ifelse(is.null(data_fetch$round_res),51,max(data_fetch$round_res$round)+1)

                                    ## Progress bar
                                    withProgress(message = 'Downloading Round Results', value = 0, {
                                    incProgress(1/100, detail = 'Downloading Round Results')
                                    n = as.numeric(current_round()[1])-round

                                        while(cont)
                                        {
                                            ## Download round resuts
                                            temp <- round_stats(round_number=round)

                                            ## Replace 0 Live logloss with NA
                                            temp$round_leaderboard$Live_Logloss <- ifelse(temp$round_leaderboard$Live_Logloss==0,NA,temp$round_leaderboard$Live_Logloss)

                                            ## Ranking fix
                                            temp$round_leaderboard <- temp$round_leaderboard[order(temp$round_leaderboard$Paid_NMR,temp$round_leaderboard$Live_Logloss,temp$round_leaderboard$Validation_Logloss,decreasing=c(T,F,F)),]

                                            ## Conditionalise the scrape indicator
                                            cont = temp$round_info$If_Resolved

                                            ## Add to existing data
                                            if(cont)
                                            {
                                                data_fetch$round_res <- rbind(data_fetch$round_res,
                                                                                cbind(
                                                                                        round=temp$round_info$Round_Number,temp$round_leaderboard,
                                                                                        rank = 1:nrow(temp$round_leaderboard)
                                                                                    )
                                                                            )
                                                round = round + 1
                                            }
                                            # Increment the progress bar, and update the detail text.
                                            incProgress(1/n, detail = paste("Downloading Round Results", round))
                                        }

                                        ## Cache the updated result file
                                        if(!identical(data_fetch$round_res,cache))
                                        {
                                            cache <- data_fetch$round_res
                                            save("cache",file="data/cache.Rdata")
                                        }
                                    })

                                })
```
    
Row {data-height=300}
-------------------------------------

### User Tournament Ranking Across Time

```{r, fig.width=10, fig.height=5}
renderPlotly({
                ## Return Null if no user information loaded
                if(is.null(data_fetch$uinfo$Username)) return(NULL)

                ## Prepare data set and preformatiing
                data <- data_fetch$round_res[data_fetch$round_res$Username == data_fetch$uinfo$Username,]

                ## Plot the line plot
                ggplotly(ggplot(data = data,
                            aes(x = round, y = rank)) +
                            geom_point() +
                            geom_line() +
                            scale_x_continuous(breaks = seq(min(data$round), max(data$round)), limits = c(min(data$round), max(data$round))) +
                            ylab("Rank") +
                            xlab("Round Number") +
                            theme(
                                    plot.background = element_rect(fill = "transparent",colour = NA),
                                    legend.background = element_rect(fill = "transparent",colour = NA),
                                    panel.background=element_rect(fill="transparent",colour=NA),
                                    panel.grid.major = element_line(colour="grey")
                                )
                        )
})
```

Row {data-height=150}
-------------------------------------

### Total Earnings : USD

```{r}
renderValueBox({
                    ## Return Null if no user information loaded
                    if(is.null(data_fetch$uinfo)) return(NULL)

                    ## Return the value for value box
                    valueBox(sum(as.numeric(as.character(data_fetch$uinfo$Payments$USD))), icon = "fa-dollar")
                })
```

### Total Earnings : NMR

```{r}
renderValueBox({
                    ## Return Null if no user information loaded
                    if(is.null(data_fetch$uinfo)) return(NULL)

                    ## Return the value for value box
                    valueBox(sum(as.numeric(as.character(data_fetch$uinfo$Payments$NMR))), icon = "fa-gg-circle")
                })
```

### Number of rounds participated

```{r}
renderValueBox({
                    ## Return Null if no user information loaded
                    if(is.null(data_fetch$uinfo$Username)) return(NULL)

                    ## Prepare data set and preformatiing
                    data1 <- data_fetch$round_res[data_fetch$round_res$Username == data_fetch$uinfo$Username,]

                    ## Return the value for value box
                    valueBox(nrow(data1), icon = "fa-users",color = "#a6bddb")
                })
```

### Average live logloss across all participated tournaments

```{r}
renderValueBox({
                    ## Return Null if no user information loaded
                    if(is.null(data_fetch$uinfo)) return(NULL)

                    ## Prepare return value
                    value <- round(mean(data_fetch$round_res$Live_Logloss[data_fetch$round_res$Username==data_fetch$uinfo$Username],na.rm=TRUE),5)
                    if(is.na(value)) value <- NULL
                
                    ## Return the value for value box
                    valueBox(value, icon = "fa-adjust",color = "warning")
                })
```

### Average validation logloss across all participated tournaments

```{r}
renderValueBox({
                    ## Return Null if no user information loaded
                    if(is.null(data_fetch$uinfo)) return(NULL)

                    ## Prepare return value
                    value <- round(mean(data_fetch$round_res$Validation_Logloss[data_fetch$round_res$Username==data_fetch$uinfo$Username],na.rm=TRUE),5)
                    if(is.na(value)) value <- NULL
                
                    ## Return the value for value box
                    valueBox(value, icon = "fa-adjust",color = "warning")
                })
```

Row {data-height=150}
-------------------------------------

### Total Earnings : USD (Staked Tournaments)

```{r}
renderValueBox({
                    ## Return Null if no user information loaded
                    if(is.null(data_fetch$uinfo)) return(NULL)

                    ## Return the value for value box
                    valueBox(sum(data_fetch$round_res$Stake_Paid[data_fetch$round_res$Username==data_fetch$uinfo$Username]), icon = "fa-dollar")
                })
```

### Cumulative NMR Burned

```{r}
renderValueBox({
                    ## Return Null if no user information loaded
                    if(is.null(data_fetch$uinfo)) return(NULL)

                    ## Prepare return value
                    value <- sum(data_fetch$round_res$Stake_Amount[data_fetch$round_res$Username==data_fetch$uinfo$Username & data_fetch$round_res$Stake_Destroyed],na.rm=TRUE)

                    ## Return the value for value box
                    valueBox(value, icon = "fa-gg-circle")
                })
```

### Number of Rounds better than random logloss on live data

```{r}
renderValueBox({
                    ## Return Null if no user information loaded
                    if(is.null(data_fetch$uinfo$Username)) return(NULL)

                    ## Prepare data set and preformatiing
                    data2 <- data_fetch$round_res[data_fetch$round_res$Username == data_fetch$uinfo$Username,]

                    ## Return the value for value box
                    valueBox(sum(data2$Live_Logloss < abs(log(.5)),na.rm=TRUE), icon = "fa-users",color = "#a6bddb")
                })
```

### SD of live logloss across all participated tournaments

```{r}
renderValueBox({
                    ## Return Null if no user information loaded
                    if(is.null(data_fetch$uinfo)) return(NULL)

                    ## Prepare return value
                    value <- round(sd(data_fetch$round_res$Live_Logloss[data_fetch$round_res$Username==data_fetch$uinfo$Username],na.rm=TRUE),5)
                    if(is.na(value)) value <- NULL
                
                    ## Return the value for value box
                    valueBox(value, icon = "fa-bullseye",color = "warning")
                })
```

### SD of validation logloss across all participated tournaments

```{r}
renderValueBox({
                    ## Return Null if no user information loaded
                    if(is.null(data_fetch$uinfo)) return(NULL)

                    ## Prepare return value
                    value <- round(sd(data_fetch$round_res$Validation_Logloss[data_fetch$round_res$Username==data_fetch$uinfo$Username],na.rm=TRUE),5)
                    if(is.na(value)) value <- NULL
                
                    ## Return the value for value box
                    valueBox(value, icon = "fa-bullseye",color = "warning")
                })
```


Individual Stats
=====================================     

Inputs {.sidebar data-width=300}
-----------------------------------------------------------------------

```{r}
h4("Configuration")
output$user_ui <- renderUI({selectizeInput("users", "Users", choices = unique(data_fetch$round_res$Username), multiple = TRUE,options = list(maxItems = 5, placeholder = 'Search & Select Users'))})
uiOutput("user_ui")
```

Row {.tabset .tabset-fade}
-------------------------------------
   
### Rank

```{r}
renderPlotly({
                ## Return Null if no user information loaded
                if(is.null(input$users)) return(NULL)

                ## Prepare data set and preformatiing
                data = data_fetch$round_res[data_fetch$round_res$Username %in% input$users,]
    
                ## Plot the line plot
                ggplotly(ggplot(data = data,
                            aes_string(x = "round", y = "rank",group = "Username", colour = "Username")) +
                            geom_point() + 
                            geom_line() +
                            scale_x_continuous(breaks = seq(min(data$round), max(data$round)), limits = c(min(data$round), max(data$round))) +
                            ylab("Rank") +
                            xlab("Round Number") +
                            theme(
                                    plot.background = element_rect(fill = "transparent",colour = NA),
                                    legend.background = element_rect(fill = "transparent",colour = NA),
                                    panel.background=element_rect(fill="transparent",colour=NA),
                                    panel.grid.major = element_line(colour="grey")
                                )
                        )
})
```   
 
### Live Logloss
    
```{r}
renderPlotly({
                ## Return Null if no user information loaded
                if(is.null(input$users)) return(NULL)

                ## Prepare data set and preformatiing
                data = data_fetch$round_res[data_fetch$round_res$Username %in% input$users & !is.na(data_fetch$round_res$Live_Logloss),]
    
                ## Plot the line plot
                ggplotly(ggplot(data = data,
                            aes_string(x = "round", y = "Live_Logloss",group = "Username", colour = "Username")) +
                            geom_point() + 
                            geom_line() +
                            scale_x_continuous(breaks = seq(min(data$round), max(data$round)), limits = c(min(data$round), max(data$round))) +
                            geom_hline(yintercept=-log(0.5)) +
                            ylab("Live Logloss") +
                            xlab("Round Number") +
                            theme(
                                    plot.background = element_rect(fill = "transparent",colour = NA),
                                    legend.background = element_rect(fill = "transparent",colour = NA),
                                    panel.background=element_rect(fill="transparent",colour=NA),
                                    panel.grid.major = element_line(colour="grey")
                                )
                        )
})
```

### Validation Logloss 
    
```{r}
renderPlotly({
                ## Return Null if no user information loaded
                if(is.null(input$users)) return(NULL)

                ## Prepare data set and preformatiing
                data = data_fetch$round_res[data_fetch$round_res$Username %in% input$users,]
    
                ## Plot the line plot
                ggplotly(ggplot(data = data,
                            aes_string(x = "round", y = "Validation_Logloss",group = "Username", colour = "Username")) +
                            geom_point() + 
                            geom_line() +
                            scale_x_continuous(breaks = seq(min(data$round), max(data$round)), limits = c(min(data$round), max(data$round))) +
                            geom_hline(yintercept=-log(0.5)) +
                            ylab("Validation Logloss") +
                            xlab("Round Number") +
                            theme(
                                    plot.background = element_rect(fill = "transparent",colour = NA),
                                    legend.background = element_rect(fill = "transparent",colour = NA),
                                    panel.background=element_rect(fill="transparent",colour=NA),
                                    panel.grid.major = element_line(colour="grey")
                                )
                        )
})
```

### USD Earned
    
```{r}
renderPlotly({
                ## Return Null if no user information loaded
                if(is.null(input$users)) return(NULL)

                ## Prepare data set and preformatiing
                data = data_fetch$round_res[data_fetch$round_res$Username %in% input$users,]
                data$Paid_USD <- data$Paid_USD + data$Stake_Paid
    
                ## Plot the line plot
                ggplotly(ggplot(data = data,
                            aes_string(x = "round", y = "Paid_USD",group = "Username", colour = "Username")) +
                            geom_point() + 
                            geom_line() +
                            scale_x_continuous(breaks = seq(min(data$round), max(data$round)), limits = c(min(data$round), max(data$round))) +
                            ylab("Total USD Earned") +
                            xlab("Round Number") +
                            theme(
                                    plot.background = element_rect(fill = "transparent",colour = NA),
                                    legend.background = element_rect(fill = "transparent",colour = NA),
                                    panel.background=element_rect(fill="transparent",colour=NA),
                                    panel.grid.major = element_line(colour="grey")
                                )
                        )
})
```

### NMR Earned
    
```{r}
renderPlotly({
                ## Return Null if no user information loaded
                if(is.null(input$users)) return(NULL)

                ## Prepare data set and preformatiing
                data = data_fetch$round_res[data_fetch$round_res$Username %in% input$users,]
    
                ## Plot the line plot
                ggplotly(ggplot(data = data,
                            aes_string(x = "round", y = "Paid_NMR_Total",group = "Username", colour = "Username")) +
                            geom_point() + 
                            geom_line() +
                            scale_x_continuous(breaks = seq(min(data$round), max(data$round)), limits = c(min(data$round), max(data$round))) +
                            ylab("NMR Earned") +
                            xlab("Round Number") +
                            theme(
                                    plot.background = element_rect(fill = "transparent",colour = NA),
                                    legend.background = element_rect(fill = "transparent",colour = NA),
                                    panel.background=element_rect(fill="transparent",colour=NA),
                                    panel.grid.major = element_line(colour="grey")
                                )
                        )
})
```

### Consistency
    
```{r}
renderPlotly({
                ## Return Null if no user information loaded
                if(is.null(input$users)) return(NULL)

                ## Prepare data set and preformatiing
                data = data_fetch$round_res[data_fetch$round_res$Username %in% input$users,]
    
                ## Plot the line plot
                ggplotly(ggplot(data = data,
                            aes_string(x = "round", y = "Consistency",group = "Username", colour = "Username")) +
                            geom_point() + 
                            geom_line() +
                            scale_x_continuous(breaks = seq(min(data$round), max(data$round)), limits = c(min(data$round), max(data$round))) +
                            ylab("Consistency") +
                            xlab("Round Number") +
                            theme(
                                    plot.background = element_rect(fill = "transparent",colour = NA),
                                    legend.background = element_rect(fill = "transparent",colour = NA),
                                    panel.background=element_rect(fill="transparent",colour=NA),
                                    panel.grid.major = element_line(colour="grey")
                                )
                        )
})
```

Row {data-height=400}
-------------------------------------
   
### Statistics Table

```{r}
renderDataTable({
                    ## Return Null if no user information loaded
                    if(is.null(input$users)) return(NULL)

                    ## Prepare data set and preformatiing
                    data = data_fetch$round_res[data_fetch$round_res$Username %in% input$users,]
                    data %>%
                    group_by(Username) %>%
                    summarise(
                                `USD Earned (Main)` = sum(Paid_USD),
                                `USD Earned (Staked)` = sum(Stake_Paid),
                                `Total NMR Earned` = sum(Paid_NMR_Total,na.rm=TRUE),
                                `Total NMR Destroyed` = sum(Stake_Amount[Stake_Destroyed],na.rm=TRUE),
                                `Total Participated Rounds`= length(Username),
                                `Total Staked Rounds` = sum(Stake_Amount>0),
                                `# Rounds with Earnings` = sum(Paid_NMR>0),
                                `# Rounds with Stake Winnings` = sum(Stake_Paid>0),
                                `# Rounds better than random Live Logloss` = sum(Live_Logloss < -log(.5) & !is.na(Live_Logloss)),
                                `Average Overfitting Differentiation` = sum(((Live_Logloss-Validation_Logloss)^2)[!is.na(Live_Logloss)])^.5,
                                `Average Amount of NMR staked` = ifelse(length(Stake_Amount[Stake_Amount>0])==0,0,mean(Stake_Amount[Stake_Amount>0],na.rm=TRUE)),
                                `Average Confidence across staked rounds` = mean(Stake_Confidence,na.rm=TRUE)
                            ) -> data_out

                    data_out <- as.data.frame(t(data_out))
                    names(data_out) <- as.character(unlist(data_out[1,]))
                    data_out[-1,,drop=FALSE]
}, options = list( paging = FALSE,searching = FALSE,bInfo = FALSE,scrollY="200px", scrollX="300px"))
```

Group Stats
=====================================

Inputs {.sidebar data-width=300}
-----------------------------------------------------------------------

```{r}
br()
selectizeInput("stat_sel", label="Select Statistic", choices = c( "USD Earned (Main)",
                                                    "USD Earned (Staked)",
                                                    "Total NMR Earned",
                                                    "Total NMR Burned",
                                                    "Total Participated Rounds",
                                                    "Total Staked Rounds",
                                                    "# Rounds with Earnings",
                                                    "# Rounds with Stake Winnings",
                                                    "# Rounds better than random Live Logloss",
                                                    "Average Amount of NMR staked"
                                                )
                )
br()
output$tab_ui <- renderUI({
                                if(is.null(data_stat$num_p)) return(NULL)
                                list(
                                    tagList(div(class = "section level3 value-box bg-primary", style = "flex: 576 576 0px; background-color: rgb(166, 189, 219);",
                                           div(class = "inner",
                                             p(class = "value", 
                                               HTML(paste0("<span class='value-output' data-icon='fa-users'>",formatC(data_stat$num_p, format="d", big.mark=","),"</span>"))),
                                             p(class = "caption", "Number of Data Scientists")),
                                           div(class = "icon",
                                               HTML("<i class='fa fa-users'></i>")))
                                           
                                         ),
                                    tagList(div(class = "section level3 value-box bg-primary", style = "flex: 576 576 0px;",
                                           div(class = "inner",
                                             p(class = "value", 
                                               HTML(paste0("<span class='value-output' data-icon='fa-users'>",formatC(data_stat$cum_usd_e, format="d", big.mark=","),"</span>"))),
                                             p(class = "caption", "Cumulative USD Earned")),
                                           div(class = "icon",
                                               HTML("<i class='fa fa-dollar'></i>")))
                                           
                                         ),
                                    tagList(div(class = "section level3 value-box bg-primary", style = "flex: 576 576 0px;",
                                           div(class = "inner",
                                             p(class = "value", 
                                               HTML(paste0("<span class='value-output' data-icon='fa-users'>",formatC(data_stat$cum_nmr_e, format="d", big.mark=","),"</span>"))),
                                             p(class = "caption", "Cumulative NMR Earned")),
                                           div(class = "icon",
                                               HTML("<i class='fa fa-gg-circle'></i>")))
                                           
                                         ),
                                    tagList(div(class = "section level3 value-box bg-primary", style = "flex: 576 576 0px;",
                                           div(class = "inner",
                                             p(class = "value", 
                                               HTML(paste0("<span class='value-output' data-icon='fa-users'>",formatC(data_stat$cum_nmr_d, format="d", big.mark=","),"</span>"))),
                                             p(class = "caption", "Cumulative NMR Burned")),
                                           div(class = "icon",
                                               HTML("<i class='fa fa-gg-circle'></i>")))
                                           
                                         ),
                                    tagList(div(class = "section level3 value-box bg-primary", style = "flex: 576 576 0px;",
                                           div(class = "inner",
                                             p(class = "value", 
                                               HTML(paste0("<span class='value-output' data-icon='fa-users'>",formatC(data_stat$cum_nmr_s, format="d", big.mark=","),"</span>"))),
                                             p(class = "caption", "Cumulative NMR Staked")),
                                           div(class = "icon",
                                               HTML("<i class='fa fa-gg-circle'></i>")))
                                           
                                         )
                                    )
                        })
uiOutput("tab_ui")
```  

Row {}
-------------------------------------

### Distribution across All Participants

```{r}
renderPlotly({
                ## Return Null if no data is loaded
                if(is.null(data_fetch$round_res)) return(NULL)

                ## Prepare data set and preformatiing
                data <- data_fetch$round_res %>%
                group_by(Username) %>%
                summarise(
                            "USD Earned (Main)" = sum(Paid_USD,na.rm=TRUE),
                            "USD Earned (Staked)" = sum(Stake_Paid,na.rm=TRUE),
                            "Total NMR Earned" = sum(Paid_NMR_Total,na.rm=TRUE),
                            "Total NMR Burned" = sum(Stake_Amount[Stake_Destroyed],na.rm=TRUE),
                            "Total Participated Rounds" = length(round),
                            "Total Staked Rounds" = sum(Stake_Amount>0,na.rm=TRUE),
                            "# Rounds with Earnings" = sum(Paid_NMR>0,na.rm=TRUE),
                            "# Rounds with Stake Winnings" = sum(Stake_Paid>0,na.rm=TRUE),
                            "# Rounds better than random Live Logloss" = sum(Live_Logloss < -log(.5) & !is.na(Live_Logloss)),
                            "Average Amount of NMR staked" = ifelse(length(Stake_Amount[Stake_Amount>0])==0,NA,mean(Stake_Amount[Stake_Amount>0],na.rm=TRUE)),
                            "NMR_Staked" = sum(Stake_Amount,na.rm=TRUE)

                         ) %>%
                gather(key,value, "USD Earned (Main)",
                                                    "USD Earned (Staked)",
                                                    "Total NMR Earned",
                                                    "Total NMR Burned",
                                                    "Total Participated Rounds",
                                                    "Total Staked Rounds",
                                                    "# Rounds with Earnings",
                                                    "# Rounds with Stake Winnings",
                                                    "# Rounds better than random Live Logloss",
                                                    "Average Amount of NMR staked",
                                                    "NMR_Staked"
                        )
    
                ## Plot the line plot
                data_stat$mean <- mean(data$value[data$key==input$stat_sel],na.rm=TRUE)
                data_stat$median <- median(data$value[data$key==input$stat_sel],na.rm=TRUE)
                data_stat$sd <- sd(data$value[data$key==input$stat_sel],na.rm=TRUE)
                data_stat$min <- min(data$value[data$key==input$stat_sel],na.rm=TRUE)
                data_stat$max <- max(data$value[data$key==input$stat_sel],na.rm=TRUE)
                data_stat$num_p <- length(unique(data$Username))
                data_stat$cum_nmr_e <- sum(data$value[data$key=="Total NMR Earned"])
                data_stat$cum_nmr_d <- sum(data$value[data$key=="Total NMR Burned"])
                data_stat$cum_nmr_s <- sum(data$value[data$key=="NMR_Staked"])
                data_stat$cum_usd_e <- sum(data$value[data$key %in% c("USD Earned (Main)","USD Earned (Staked)")])
                
                p <- ggplot(data[data$key==input$stat_sel,], aes(value)) +
                                ylab("Count") +
                                xlab("Statistic Value") +
                                theme_bw()
                if (input$stat_sel %in% c("Total Participated Rounds",
                                          "Total Staked Rounds",
                                          "# Rounds with Earnings",
                                          "# Rounds with Stake Winnings",
                                          "# Rounds better than random Live Logloss")) {
                    p <- p + geom_bar()
                } else {
                    p <- p + geom_histogram(bins = 200)
                }
                
                ggplotly(p)
})
```

Row {data-height=300}
-------------------------------------

```{r}
div(style = "width: 50%", renderDataTable({
                    if(is.null(data_stat$mean)) return(NULL)
                    data.frame(
                                Characteristic = c("Minimum","Mean","Median","Max","Standard Deviation"),
                                Value = round(c(data_stat$min,data_stat$mean, data_stat$median ,data_stat$max, data_stat$sd),2)
                            )
                    #if(input$stat_sel %in% c("USD Earned (Main)","USD Earned (Staked)")) return(data_out[1:4,])
                    #if(input$stat_sel %in% c("Total NMR Earned","Total NMR Destroyed",)) return(data_out[-4,])
},rownames=FALSE,colnames=NULL, options = list( paging = FALSE,searching = FALSE,bInfo = FALSE,scrollY="200px", scrollX="300px")))
```

Group Performance
=====================================     
   
Row {.tabset .tabset-fade}
-------------------------------------

### Participation

```{r}
renderPlotly({
                ## Return Null if no data is loaded
                if(is.null(data_fetch$round_res)) return(NULL)

                ## Prepare data set and preformatiing
                data <- data_fetch$round_res %>%
                group_by(round) %>%
                summarise(
                            `# of Participants (Main)` = length(Live_Logloss),
                            `# of Participants (Staked)` = length(Live_Logloss[Stake_Amount>0])
                         ) %>%
                gather(key,value, `# of Participants (Main)`, `# of Participants (Staked)`)

                ## Hide Staking participation below round 61
                data <- data[data$value!=0,]
    
                ## Plot the line plot
                ggplotly(ggplot(data = data,
                                    aes_string(x = "round",y="value",colour="key")) +
                                    geom_line()+
                                    geom_point()+
                                    scale_x_continuous(breaks = seq(min(data$round), max(data$round)), limits = c(min(data$round), max(data$round))) +
                                    scale_y_continuous(breaks = seq(0, max(2000, max(data$value)), by = 200)) +
                                    ylab("Number of Submissions") +
                                    xlab("Round Number") +
                                    theme(
                                            plot.background = element_rect(fill = "transparent",colour = NA),
                                            legend.background = element_rect(fill = "transparent",colour = NA),
                                            panel.background=element_rect(fill="transparent",colour=NA),
                                            panel.grid.major = element_line(colour="grey"),
                                            legend.title=element_blank()
                                        )
                        )
})
```   
   
### Winning Submissions Performance

```{r}
renderPlotly({
                ## Return Null if no data is loaded
                if(is.null(data_fetch$round_res)) return(NULL)

                ## Prepare data set and preformatiing
                data <- data_fetch$round_res %>%
                group_by(round) %>%
                summarise(
                            `Best Winning Live Logloss (Main)` = min(Live_Logloss[!Banned],na.rm=TRUE),
                            #`Worst Winning Live Logloss (Main)` = max(Live_Logloss[Paid_NMR>0],na.rm=TRUE),
                            `Best Winning Live Logloss (Staked)` = min(Live_Logloss[Stake_Paid>0],na.rm=TRUE),
                            `Worst Winning Live Logloss (Staked)` = max(Live_Logloss[Stake_Paid>0],na.rm=TRUE),
                            #`Average Winning Live Logloss (Main)` = mean(Live_Logloss[Paid_NMR>0],na.rm=TRUE),
                            `Average Winning Live Logloss (Staked)` = mean(Live_Logloss[Stake_Paid>0],na.rm=TRUE)
                         ) %>%
                #gather(key,value, `Best Winning Live Logloss (Main)`,`Worst Winning Live Logloss (Main)`,`Best Winning Live Logloss (Staked)`,`Worst Winning Live Logloss (Staked)`,`Average Winning Live Logloss (Main)`,`Average Winning Live Logloss (Staked)`)
                gather(key,value, `Best Winning Live Logloss (Main)`,`Best Winning Live Logloss (Staked)`,`Worst Winning Live Logloss (Staked)`,`Average Winning Live Logloss (Staked)`)
    
                ## Plot the line plot
                style(ggplotly(ggplot(data = data,
                                    aes_string(x = "round",y="value",colour="key")) +
                                    geom_line()+
                                    geom_point()+
                                    scale_x_continuous(breaks = seq(min(data$round), max(data$round)), limits = c(min(data$round), max(data$round))) +
                                    scale_y_continuous(breaks=seq(0,1,by=.0005))+
                                    ylab("Live Log-Loss") +
                                    xlab("Round Number") +
                                    geom_hline(yintercept=-log(0.5)) +
                                    theme(
                                            plot.background = element_rect(fill = "transparent",colour = NA),
                                            legend.background = element_rect(fill = "transparent",colour = NA),
                                            panel.background=element_rect(fill="transparent",colour=NA),
                                            panel.grid.major = element_line(colour="grey"),
                                            legend.title=element_blank()
                                        )
                        ),visible="legendonly",traces=c(1,4))
})
```   

### Comparison To Random

```{r}
renderPlotly({
                ## Return Null if no data is loaded
                if(is.null(data_fetch$round_res)) return(NULL)

                ## Prepare data set and preformatiing
                data <- data_fetch$round_res %>%
                group_by(round) %>%
                summarise(
                            `% Better Than Random Logloss (Main)` = round(100*(sum(Live_Logloss < -log(.5),na.rm=TRUE)/length(Live_Logloss)),2),
                            `% Better Than Random Logloss (Staked)` = round(100*(sum(Live_Logloss[Stake_Amount>0] < -log(.5),na.rm=TRUE)/length(Live_Logloss[Stake_Amount>0])),2)
                         ) %>%
                gather(key,value, `% Better Than Random Logloss (Main)`, `% Better Than Random Logloss (Staked)`)
    
                ## Plot the line plot
                ggplotly(ggplot(data = data,
                                    aes_string(x = "round",y="value",colour="key")) +
                                    geom_line()+
                                    geom_point()+
                                    scale_x_continuous(breaks = seq(min(data$round), max(data$round)), limits = c(min(data$round), max(data$round))) +
                                    scale_y_continuous(breaks = seq(0, 100, by = 10)) +
                                    ylab("Percentage of Submissions") +
                                    xlab("Round Number") +
                                    theme(
                                            plot.background = element_rect(fill = "transparent",colour = NA),
                                            legend.background = element_rect(fill = "transparent",colour = NA),
                                            panel.background=element_rect(fill="transparent",colour=NA),
                                            panel.grid.major = element_line(colour="grey"),
                                            legend.title=element_blank()
                                        )
                        )
})
``` 

### Staking: S/C Ratios
    
```{r}
renderPlot({
                ## Return Null if no data is loaded
                if(is.null(data_fetch$round_res)) return(NULL)

                ## Prepare data set and preformatiing
                data <- data_fetch$round_res
                data <- data[data$Stake_Amount>0 & data$Stake_Confidence >0 ,]#& data$round > max(data$round)-8,]
                data$sc_ratio = data$Stake_Amount / data$Stake_Confidence
                data$round <- factor(as.character(data$round),levels = as.character(unique(sort(data$round,decreasing=TRUE))))
                
                ## Plot the Joy Plot
                ggplot(data = data,
                        aes(x = sc_ratio, y = round)) +
                        geom_density_ridges(scale=5,height=2,fill="red",alpha=.2)+
                        ylab("Round Number") +
                        xlab("Stake/Confidence Ratio") +
                        scale_x_continuous(limits=c(-200, 1500))+
                        theme(
                                plot.background = element_rect(fill = "transparent",colour = NA),
                                legend.background = element_rect(fill = "transparent",colour = NA),
                                panel.background=element_rect(fill="transparent",colour=NA),
                                panel.grid.major = element_line(colour="grey")
                            )
})
```

### Staking: NMR

```{r}
renderPlotly({
                ## Return Null if no data is loaded
                if(is.null(data_fetch$round_res)) return(NULL)

                ## Prepare data set and preformatiing
                data <- data_fetch$round_res %>%
                group_by(round) %>%
                summarise(
                            `NMR Burned` = sum(Stake_Amount[Stake_Destroyed],na.rm=TRUE),
                            `NMR Staked` = sum(Stake_Amount,na.rm=TRUE)
                         ) %>%
                gather(key,value, `NMR Burned`, `NMR Staked`)

                ## Hide data below round 61
                data <- data[data$round>60,]
    
                ## Plot the line plot
                ggplotly(ggplot(data = data,
                                    aes_string(x = "round", y = "value",colour="key")) +
                                    geom_point() + 
                                    geom_line() +
                                    scale_x_continuous(breaks = seq(min(data$round), max(data$round)), limits = c(min(data$round), max(data$round))) +
                                    scale_y_continuous(breaks = seq(0, 5000, by = 500)) +
                                    ylab("NMR") +
                                    xlab("Round Number") +
                                    theme(
                                            plot.background = element_rect(fill = "transparent",colour = NA),
                                            legend.background = element_rect(fill = "transparent",colour = NA),
                                            panel.background=element_rect(fill="transparent",colour=NA),
                                            panel.grid.major = element_line(colour="grey"),
                                            legend.title=element_blank()
                                        )
                        )
})
```

### Staking: Confidence

```{r}
renderPlotly({
                ## Return Null if no data is loaded
                if(is.null(data_fetch$round_res)) return(NULL)

                ## Prepare data set and preformatiing
                data <- data_fetch$round_res %>%
                group_by(round) %>%
                summarise(
                            #`Minimum Confidence` = min(Stake_Confidence[Stake_Amount>0]),
                            #`Maximum Confidence` = max(Stake_Confidence[Stake_Amount>0]),
                            `Minimum Winning Confidence` = min(Stake_Confidence[Stake_Amount>0 & Stake_Paid>0])
                         ) %>%
                gather(key,value,`Minimum Winning Confidence`)#, `Minimum Confidence`,`Maximum Confidence`,)

                ## Hide data below round 61
                data <- data[data$round>60,]
    
                ## Plot the line plot
                style(ggplotly(ggplot(data = data,
                                    aes_string(x = "round", y = "value",colour="key")) +
                                    geom_point() + 
                                    geom_line() +
                                    scale_x_continuous(breaks = seq(min(data$round), max(data$round)), limits = c(min(data$round), max(data$round))) +
                                    scale_y_continuous() +
                                    ylab("Confidence") +
                                    xlab("Round Number") +
                                    theme(
                                            plot.background = element_rect(fill = "transparent",colour = NA),
                                            legend.background = element_rect(fill = "transparent",colour = NA),
                                            panel.background=element_rect(fill="transparent",colour=NA),
                                            panel.grid.major = element_line(colour="grey"),
                                            legend.title=element_blank()
                                        )
                        ))#,visible="legendonly",traces=c(1,2))
})
```
